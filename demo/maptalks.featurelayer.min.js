/*!
 * maptalks.featurelayer v2.0.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],t):t(e.maptalks=e.maptalks||{},e.maptalks)}(this,function(e,t){"use strict";function r(e,t){for(var r=Object.getOwnPropertyNames(t),o=0;o<r.length;o++){var n=r[o],a=Object.getOwnPropertyDescriptor(t,n);a&&a.configurable&&void 0===e[n]&&Object.defineProperty(e,n,a)}return e}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):r(e,t))}var i=function(e){function r(t,a,i){o(this,r);var s={}||i,l=n(this,e.call(this,s));return l.setId(t),l.breakClassRender=!1,l.selected=!1,l.loadend=!1,l.featureCount=0,l.geometryList=[],l.breakClassRender=l.breakClassRender||s.breakClassRender,l.selected=l.selected||s.selected,l.query=l.query||s.query,l.displayField=l.displayField||s.displayField,l.outputLayerName=l.outputLayerName||s.layerName,l._postDataFrom(a),l}return a(r,e),r.addFeature=function(e){return this.addGeometry(e)},r.prototype.addGeometry=function(r){for(var o=0,n=r.length;o<=n;o++)if(!r[o]instanceof t.Geometry)throw new Error("Only a geometry can be added into a Layer");1==this.breakClassRender&&this._breakRenderLayer(this.breakClasses,r);var a=e.prototype.addGeometry.apply(this,arguments);return this.loadend&&this.fire("loadend",{geometries:this.geometryList}),a},r.prototype.setRenderProperty=function(e){this.renderAtrribute=e,this.breakClassRender=!0},r.prototype.setBreakRender=function(e){this.breakClasses=this.breakClasses||[],e.length?e instanceof Array&&(this.breakClasses=this.breakClasses.concat(e)):this.breakClasses.push(e)},r.prototype._breakRenderLayer=function(e,t){if(!e)throw new Error("you need set render field and set rendered classes!");if(!e.length)return void this.setBreakRender(e);if(!this.layerData)throw new Error("layer data not exist!");if(e instanceof Array){for(var r=t.length,o=this,n=0;n<r;n++){var a=this.layerData.features[n];a.attributes[this.renderAtrribute]=1e5*Math.random()}e.forEach(function(e){for(var n=0;n<r;n++){var a=o.layerData.features[n],i=o._getGeometry(t,a.attributes.OBJECTID),s=parseInt(a.attributes[o.renderAtrribute]);s>=e.minValue&&s<e.maxValue&&i.setSymbol(e.renderSymbol)}})}},r.prototype._getGeometry=function(e,t){if(e.length)for(var r=0;r<e.length;r++)if(e[r].getId()===t)return e[r]},r.prototype._postDataFrom=function(e){var r=e;this.dataUrl=e;var o=this,n="../proxy/proxy.ashx",a=n;t.Ajax.post({url:a},"url="+encodeURIComponent(r)+"&filter="+encodeURIComponent("?f=pjson"),function(e,n){var i=t.Util.parseJSON(n),s="/query?text=&geometry=&geometryType=esriGeometryPoint&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&objectIds=&where=1%3D1&time=&returnCountOnly=true&returnIdsOnly=false&returnGeometry=true&maxAllowableOffset=&outSR=&outFields=&f=pjson";t.Ajax.post({url:a},"url="+encodeURIComponent(r)+"&filter="+encodeURIComponent(s),function(e,n){if(!e)for(var s=t.Util.parseJSON(n),l=s.count,u=Math.ceil(l/1e3),f=1;f<=u;f++){var y="/query?&where=",d="OBJECTID>="+(1e3*(f-1)).toString()+"and OBJECTID<"+(1e3*f).toString(),c="&text=&geometry=&geometryType=esriGeometryPoint&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&objectIds=&time=&returnCountOnly=false&returnIdsOnly=false&returnGeometry=true&maxAllowableOffset=&outSR=&outFields=*&f=pjson",p=y+d+c;t.Ajax.post({url:a},"url="+encodeURIComponent(r)+"&filter="+encodeURIComponent(p),function(e,r){if(!e){var n=t.Util.parseJSON(r),a=n.features.length;console.log(a+":"+o.getId()),o.featureCount+=a,o.featureCount>=l-1&&(o.loadend=!0);var s={data:n,info:i},u=o._addData(s);o.geometryList=o.geometryList.concat(u),o.addGeometry(u)}})}})})},r.prototype._addData=function(e){var t=null;if(e instanceof Object){if(!e.info.geometryType)throw new Error("The layer's geometry type is unknown");switch(e.info.geometryType){case"esriGeometryPoint":t=this._processMarkers(e);break;case"esriGeometryPolygon":t=this._processPolygons(e);break;case"esriGeometryPolyline":t=this._processPolylines(e)}return t}},r.prototype._processMarkers=function(e){this.layerData=e.data;var r,o=e.data.features;e.info.drawingInfo.renderer.symbol&&(r=e.info.drawingInfo.renderer.symbol.type),e.info.drawingInfo.renderer.type&&(r=e.info.drawingInfo.renderer.type);var n;n="esriPMS"==r||"uniqueValue"==r?this._getPicMarkerSymbol(e.info.drawingInfo):this._parseEsriSymbol(e.info.drawingInfo.renderer.symbol||e.info.drawingInfo.renderer.defaultSymbol);for(var a=[],i=o.length,s=0;s<i;s++){var l=o[s],u=new t.Marker([l.geometry.x,l.geometry.y],{symbol:n});1==this.query&&this._setInfoWindow(u,l.attributes),u.attributes=l.attributes,u.setId(l.attributes.OBJECTID),a.push(u)}return a},r.prototype._startBreakRenderLayer=function(){if(!this.layerData||!this._examField(this.layerData.fields,this.renderAtrribute))throw new Error("attribute you set not exist in featurelayer's fields");this._breakRenderLayer(this.breakClassRender)},r.prototype._processPolygons=function(e){this.layerData=e.data;var r,o=e.data.features;e.info.drawingInfo.renderer.symbol&&(r=this._parseEsriSymbol(e.info.drawingInfo.renderer.symbol));for(var n=[],a=o.length,i=0;i<a;i++){var s=o[i];if(s.geometry){var l=null;l="classBreaks"==e.info.drawingInfo.renderer.type?new t.Polygon(s.geometry.rings,{symbol:this._parseBreakSymbol(e.info.drawingInfo.renderer,s.attributes)}):new t.Polygon(s.geometry.rings,{symbol:r}),l.attributes=s.attributes;l.getSymbol();if(1==this.selected){var u=0;l.on("mouseover",function(e){var t=e.target,r=t.getSymbol().polygonOpacity;u=u<r&&0!=u?u:r;var o=r+.2<=1?r+.2:1;t.getSymbol();target.updateSymbol({polygonOpacity:o}),t.on("mouseout",function(e){var t=e.target;t.updateSymbol({polygonOpacity:u})})})}1==this.query&&this._setInfoWindow(l),l.setId(s.attributes.OBJECTID),n.push(l)}else console.log("this feature has no geometry\uff1a"+i)}return n},r.prototype._processPolylines=function(e){this.layerData=e.data;var r=e.data.features,o=e.info.drawingInfo.renderer.symbol||e.info.drawingInfo.renderer.defaultSymbol,n=[];if(r)var a=r.length;for(var i=0;i<a;i++){var s=r[i],l=s.geometry.paths,u=new t.MultiLineString(l,{symbol:{lineColor:"rgb("+o.color[0]+","+o.color[1]+","+o.color[2]+")",lineWidth:o.width,lineOpacity:1}});1==this.query&&this._setInfoWindow(u,s.attributes),u.attributes=s.attributes,u.setId(s.attributes.OBJECTID),n.push(u)}return n},r.prototype._examField=function(e,t){if(e instanceof Array&&t){for(var r=0;r<e.length;r++)if(e[r].name==t)return!0;return!1}throw new Error("attribute you set not in featurelayer's fields")},r.prototype._parseEsriSymbol=function(e){var t;if(e){if("esriSMS"==e.type)return t={markerType:"ellipse",markerLineColor:"rgb("+e.outline.color[0]+","+e.outline.color[1]+","+e.outline.color[2]+")",lineWidth:e.outline.width,markerLineOpacity:1,markerFill:"rgb("+e.color[0]+","+e.color[1]+","+e.color[2]+")",markerFillOpacity:1,markerWidth:e.size+1,markerHeight:e.size+1};if("esriSFS"==e.type){var r,o=e.color?"rgb("+e.color[0]+","+e.color[1]+","+e.color[2]+e.color[3]+")":"#fff",r=e.color?1:0;return r=e.color?0==e.color[0]&&0==e.color[1]&&0==e.color[2]?0:1:0,t={lineColor:"rgb("+e.outline.color[0]+","+e.outline.color[1]+","+e.outline.color[2]+e.outline.color[3]+")",lineWidth:e.outline.width,lineOpacity:1,polygonFill:o,polygonOpacity:r}}}},r.prototype._parseBreakSymbol=function(e,t){if("classBreaks"==e.type)for(var r=null,o=e.classBreakInfos,n=e.field,a=0;a<o.length;a++)if(t[n]<o[a].classMaxValue){var i=o[a].symbol;return r={polygonFill:"rgba("+i.color[0]+","+i.color[1]+","+i.color[2]+","+i.color[3]+")",lineColor:"rgba("+i.outline.color[0]+","+i.outline.color[1]+","+i.outline.color[2]+","+i.outline.color[3]+")",lineWidth:i.color.width}}},r.prototype._getPicMarkerSymbol_=function(e,t){if(e&&t)for(var r=t.length,o=0;o<r;o++){var n=t[o];if(n.value==e)return{markerFile:this.dataUrl+"/images/"+n.symbol.url,markerWidth:n.symbol.width,markerHeight:n.symbol.height}}},r.prototype._getPicMarkerSymbol=function(e){if(e){var t=e.renderer.symbol||e.renderer.defaultSymbol,r=t.url,o=t.width,n=t.height;return{markerFile:this.dataUrl+"/images/"+r,markerWidth:o,markerHeight:n}}},r.prototype.setInfoWin=function(e){var t=this.getGeometries();t.forEach(function(t){var r=t.attributes,o='<table cellspacing="5" class="gd_table" id="infoWin" style="font-family:"Microsoft YaHei";font-size:10px;">';for(var n in r){e[n];e[n]&&(o+='<tr><td class="gd_table_td">'+e[n]+"</td><td>\uff1a"+r[n]+"</td></tr>")}o+="</table>";var a={title:"\u5c5e\u6027\u4fe1\u606f",content:o,width:370};this._setInfoWindow(t,a)}.bind(this))},r.prototype._setInfoOption=function(e){var t=e.attributes,r='<table cellspacing="5" id="infoWin" style="color:black;font-family:"Microsoft YaHei";font-size:10px;">';for(var o in t)t[o]&&""!=t[o]&&0!=t[o]&&(r+="<tr><td>"+o+"</td><td>\uff1a"+t[o]+"</td></tr>");r+="</table>";var n={title:"\u5c5e\u6027\u4fe1\u606f",content:r};return n},r.prototype._setInfoWindow=function(e,r){var o=r||this._setInfoOption(e),n=new t.ui.InfoWindow(o),a=n.addTo(e);e.on("click",function(e){a.isVisible()?a.hide():a.show(e.target.getCenter())})},r.prototype._addLabel=function(e){var t=[];return e.forEach(function(e){e.label&&t.push(e.label)}),t},r.prototype._getLayerIndex=function(e,t){for(var r=0;r<t.length;r++)if(e==t[r].name)return t[r].id},r}(t.VectorLayer);i.registerRenderer("canvas",function(e){function t(){return o(this,t),n(this,e.apply(this,arguments))}return a(t,e),t}(t.renderer.VectorLayerCanvasRenderer)),e.FeatureLayer=i,Object.defineProperty(e,"__esModule",{value:!0})});